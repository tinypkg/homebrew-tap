name: Update CC Switch Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 3.8.3). Leave empty to auto-detect latest version."
        required: false
        type: string
  schedule:
    - cron: "0 */12 * * *"

jobs:
  update-cask:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest version and check for updates
        id: version_check
        run: |
          # 获取当前 cask 中的版本
          CURRENT_VERSION=$(grep 'version \"' Casks/cc-switch.rb | sed 's/.*version \"\\(.*\\)\".*/\\1/')
          echo "Current version: $CURRENT_VERSION"

          # 如果手动指定了版本，使用指定的版本
          if [ -n "${{ inputs.version }}" ]; then
            NEW_VERSION="${{ inputs.version }}"
            echo "Using manually specified version: $NEW_VERSION"
          else
            # 从 GitHub API 获取最新版本
            RELEASE_INFO=$(curl -f -s "https://api.github.com/repos/farion1231/cc-switch/releases/latest")
            if [ $? -ne 0 ]; then
              echo "Failed to fetch release info"
              exit 1
            fi

            NEW_VERSION=$(echo "$RELEASE_INFO" | sed -n 's/.*"tag_name": *"v\([^"]*\)".*/\1/p' | head -n 1)
            if [ -z "$NEW_VERSION" ]; then
              echo "Failed to parse version from release info"
              exit 1
            fi
            echo "Latest available version: $NEW_VERSION"
          fi

          # 比较版本
          if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
            echo "No update needed. Current version ($CURRENT_VERSION) is up to date."
            echo "should_update=false" >> $GITHUB_OUTPUT
          else
            echo "Update available: $CURRENT_VERSION -> $NEW_VERSION"
            echo "should_update=true" >> $GITHUB_OUTPUT
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Download tar.gz
        if: steps.version_check.outputs.should_update == 'true'
        run: |
          curl -f -L -o /tmp/cc-switch.tar.gz "https://github.com/farion1231/cc-switch/releases/download/v${{ steps.version_check.outputs.new_version }}/CC-Switch-v${{ steps.version_check.outputs.new_version }}-macOS.tar.gz"
          if [ ! -f /tmp/cc-switch.tar.gz ]; then
            echo "Failed to download CC Switch tar.gz"
            exit 1
          fi

      - name: Calculate checksum
        if: steps.version_check.outputs.should_update == 'true'
        id: checksum
        run: |
          # Verify file exists and has reasonable size
          if [ ! -s /tmp/cc-switch.tar.gz ] || [ $(stat -c%s /tmp/cc-switch.tar.gz) -lt 100000 ]; then
            echo "tar.gz file is missing or too small"
            exit 1
          fi

          SHA256=$(sha256sum /tmp/cc-switch.tar.gz | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Update cask file
        if: steps.version_check.outputs.should_update == 'true'
        run: |
          # Update version
          sed -i "s/version \".*\"/version \"${{ steps.version_check.outputs.new_version }}\"/" Casks/cc-switch.rb

          # Update sha256
          sed -i "s/sha256 \".*\"/sha256 \"${{ steps.checksum.outputs.sha256 }}\"/" Casks/cc-switch.rb

      - name: Show changes
        if: steps.version_check.outputs.should_update == 'true'
        run: |
          git diff Casks/cc-switch.rb

      - name: Commit and push changes
        if: steps.version_check.outputs.should_update == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Casks/cc-switch.rb

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore: update CC Switch to version ${{ steps.version_check.outputs.new_version }}"
          git push

      - name: Summary
        if: always()
        run: |
          echo "## Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version**: ${{ steps.version_check.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest Version**: ${{ steps.version_check.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Required**: ${{ steps.version_check.outputs.should_update }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.version_check.outputs.should_update }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ Successfully updated to version ${{ steps.version_check.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ℹ️ No update needed. Already on the latest version." >> $GITHUB_STEP_SUMMARY
          fi
